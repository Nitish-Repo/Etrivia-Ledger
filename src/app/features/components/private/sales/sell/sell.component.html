<ion-header [translucent]="true">
  <app-toolbar [title]="'page.sell.title' | translate"></app-toolbar>
</ion-header>
<ion-content [fullscreen]="true" color="light">
  <div>
    @if(saleForm){
    <div>
      <form id="saleForm" [formGroup]="saleForm" (submit)="onSubmit()">
        <div class="ion-margin">
          <ion-segment mode="ios" [value]="segment()" (ionChange)="segment.set($any($event).detail.value)">
            <ion-segment-button value="invoice">
              <ion-label>{{ 'common.invoice_detail' | translate }}</ion-label>
            </ion-segment-button>
            <ion-segment-button value="option">
              <ion-label>{{ 'common.option_detail' | translate }}</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        @if (segment() === 'invoice') {
        <div>
          <ion-item lines="none" class="ion-margin-top">
            <ion-label>Invoice Date</ion-label>
            <ion-datetime-button datetime="invoiceDatetime"></ion-datetime-button>
          </ion-item>
          <ion-modal [keepContentsMounted]="true" #invoiceDatetimeModal>
            <ng-template>
              <ion-datetime #invoiceDatetime id="invoiceDatetime" presentation="date" formControlName="invoiceDate"
                (ionChange)="onDateChange($event, 'invoiceDate')">
                <ion-buttons slot="buttons">
                  <ion-button color="primary"
                    (click)="invoiceDatetime.confirm(); invoiceDatetimeModal.dismiss()">Ok</ion-button>
                </ion-buttons></ion-datetime>
            </ng-template>
          </ion-modal>



          <ion-list [inset]="true" mode="ios">
            <ion-item lines="none" [button]="true" detail="true">
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>INVOICE</strong>
                </div>
                <ion-text color="primary" class="description">
                  <strong>{{ saleForm.get('invoiceNumber')?.value || ('-' ) }}</strong>
                </ion-text>
              </ion-label>
            </ion-item>
          </ion-list>

          <ion-list [inset]="true" mode="ios">
            <ion-item lines="none" [button]="true" detail="true" (click)="navigateToSelectTemplate()">
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>Select Template</strong>
                </div>
                <!-- <ion-text color="primary" class="description">
                  <strong>{{ saleForm.get('invoiceNumber')?.value || ('-' ) }}</strong>
                </ion-text> -->
              </ion-label>
            </ion-item>
          </ion-list>

          <ion-list [inset]="true" mode="ios">
            <ion-item [button]="true" detail="true" lines="none" (click)="navigateToBusinessInfo()">
              <ion-icon color="danger" slot="start" name="id-card-outline" size="large" shape="round"></ion-icon>
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>Bill From</strong>
                </div>
                @if (businessSettings()?.businessName) {
                <ion-text color="dark" class="description">{{ businessSettings()?.businessName }}</ion-text>
                @if (businessSettings()?.gstin) {
                <ion-text color="medium" class="description" style="font-size: 0.85em;">{{ businessSettings()?.gstin
                  }}</ion-text>
                }

                } @else {
                <ion-text color="medium" class="description">Add Business</ion-text>
                }
              </ion-label>
            </ion-item>
            <div class="dotted-line"></div>
            <ion-item button detail="true" lines="none" (click)="navigateToAddCustomer()">
              <ion-icon color="danger" slot="start" name="id-card" size="large"></ion-icon>
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>Bill To</strong>
                </div>
                @if (selectedCustomer()) {
                <ion-text color="dark" class="description">{{ selectedCustomer()?.customerName }}</ion-text>
                } @else {
                <ion-text color="medium" class="description">Add Clients</ion-text>
                }
              </ion-label>
            </ion-item>
          </ion-list>

          <ion-list [inset]="true" mode="ios">
            <ion-item [button]="true" detail="true" lines="none" (click)="navigateToAddProduct()">
              <ion-icon color="danger" slot="start" name="receipt-outline" size="large" shape="round"></ion-icon>
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>Items ({{ saleItemForms().length }})</strong>
                </div>
                <ion-text color="medium" class="description">Add Items</ion-text>
              </ion-label>
            </ion-item>

            @for (itemForm of saleItemForms(); track $index) {
            <ion-item [button]="true" detail="false" (click)="editSaleItem($index)">
              <ion-label class="ion-text-wrap">
                <div class="product-header">
                  <strong>{{ itemForm.get('productName')?.value || 'Product ' + ($index + 1) }}</strong>
                  <div class="badges">
                    <ion-badge color="medium">#{{ $index + 1 }}</ion-badge>
                  </div>
                </div>
                <ion-text color="medium" class="description">
                  {{ itemForm.get('quantity')?.value }} Ã— {{ itemForm.get('pricePerUnit')?.value | currency:'INR':'symbol':'1.2-2' }}
                </ion-text>
              </ion-label>
              <ion-button slot="end" fill="outline" disabled color="medium">
                {{ ((itemForm.get('quantity')?.value || 0) * (itemForm.get('pricePerUnit')?.value || 0)) | currency:'INR':'symbol':'1.2-2' }}
              </ion-button>
              <!-- <ion-button slot="end" shape="round" size="large" fill="clear" (click)="removeSaleItem($index)" >
                <ion-icon slot="icon-only" name="trash" size="large"></ion-icon>
              </ion-button> -->
              <ion-button slot="end" shape="round" size="large" fill="clear"
                (click)="presentItemActionSheet($event, itemForm)">
                <ion-icon slot="icon-only" name="ellipsis-vertical" size="large"></ion-icon>
              </ion-button>
            </ion-item>
            }

            <ion-item lines="none">
              <ion-label>{{ 'label.taxable_amount' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (saleForm.get('taxableAmount')?.value || 0) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item lines="none">
              <ion-label>{{ 'label.total_discount_amount' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (saleForm.get('TotalDiscountAmount')?.value || 0) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item lines="none">
              <ion-label>{{ 'label.amount_after_discount' | translate }}</ion-label>
              <ion-note slot="end">
                {{ ((saleForm.get('taxableAmount')?.value || 0) - (saleForm.get('TotalDiscountAmount')?.value || 0)) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item lines="none">
              <ion-label>{{ 'label.gst' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (((saleForm.get('cgst')?.value || 0) + (saleForm.get('sgst')?.value || 0) + (saleForm.get('igst')?.value || 0))) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item lines="none">
              <ion-label>{{ 'label.cess' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (saleForm.get('cess')?.value || 0) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item>
              <ion-label>{{ 'label.total_amount' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (saleForm.get('totalAmount')?.value || 0) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>
            <ion-item>
              <ion-label slot="end">{{ 'label.grand_total' | translate }}</ion-label>
              <ion-note slot="end">
                {{ (saleForm.get('grandTotal')?.value || 0) | currency:'INR':'symbol':'1.2-2' }}
              </ion-note>
            </ion-item>

          </ion-list>

          <ion-item-divider>
            <ion-label>{{ 'common.payment_details' | translate }}</ion-label>
          </ion-item-divider>

          <div class="ion-margin">
            <div class="ion-margin-bottom">
              <app-select [meta]="paymentStatusMeta" />
            </div>

            <div class="ion-display-flex ion-margin-bottom">
              <app-input class="ion-flex-1" [form]="saleForm" name="dueAmount" label="label.due_amount"
                [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
                fill="outline"></app-input>

              <app-input class="ion-flex-1 ion-margin-start" [form]="saleForm" name="paidAmount"
                label="label.paid_amount" [placeholder]="'placeholder.enter_value'" labelPlacement="floating"
                type="number" [errorText]="'error.required'" fill="outline"></app-input>
            </div>

            <div class="ion-display-flex ion-margin-bottom ion-margin-top">
              <app-select class="ion-flex-1" [meta]="saleTypeMeta" />
              <app-select class="ion-flex-1 ion-margin-start" [meta]="statusMeta" />
            </div>

            <div class="ion-margin-bottom">
              <ion-textarea formControlName="notes" label="{{ 'label.notes' | translate }}" labelPlacement="floating"
                fill="outline" [placeholder]="'placeholder.enter_notes' | translate" autoGrow="true" [counter]="true"
                maxlength="500"></ion-textarea>
            </div>
          </div>




        </div>
        }

        @if (segment() === 'option') {
        <div class="ion-margin">
          <div class="ion-display-flex ion-margin-bottom ion-margin-top">
            <app-select class="ion-flex-1" [meta]="invoiceDiscountTypeMeta" />
            <app-input class="ion-flex-1 ion-margin-start" [form]="saleForm" name="invoiceDiscountValue"
              label="label.discount_value" [placeholder]="'placeholder.enter_value'" labelPlacement="floating"
              type="number" fill="outline"></app-input>
          </div>

          <div class="ion-display-flex ion-margin-bottom">
            <app-input class="ion-flex-1" [form]="saleForm" name="cgst" label="label.cgst"
              [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
              fill="outline"></app-input>
            <app-input class="ion-flex-1 ion-margin-start" [form]="saleForm" name="sgst" label="label.sgst"
              [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
              fill="outline"></app-input>
          </div>

          <div class="ion-display-flex ion-margin-bottom">
            <app-input class="ion-flex-1" [form]="saleForm" name="igst" label="label.igst"
              [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
              fill="outline"></app-input>
            <app-input class="ion-flex-1 ion-margin-start" [form]="saleForm" name="cess" label="label.cess"
              [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
              fill="outline"></app-input>
          </div>

        </div>

        <div>
          <ion-item-divider>
            <ion-label>{{ 'common.additional_charges' | translate }}</ion-label>
            <ion-button slot="end" size="small" (click)="addAdditionalCharge()">
              <ion-icon name="add" slot="start"></ion-icon>
              {{ 'common.add_charge' | translate }}
            </ion-button>
          </ion-item-divider>

          @for (chargeForm of additionalChargeForms(); track $index) {
          <div class="item-card">
            <form [formGroup]="chargeForm">
              <div class="ion-margin-bottom ion-margin-top">
                <app-input [form]="chargeForm" name="chargeName" label="label.charge_name"
                  [placeholder]="'placeholder.enter_charge_name'" [errorText]="'error.required'"
                  labelPlacement="floating" fill="outline"></app-input>
              </div>

              <div class="ion-margin-bottom">
                <app-input [form]="chargeForm" name="amount" label="label.amount"
                  [placeholder]="'placeholder.enter_value'" [errorText]="'error.required'" labelPlacement="floating"
                  type="number" fill="outline"></app-input>
              </div>

              <div class="ion-margin-bottom">
                <app-input [form]="chargeForm" name="hsnCode" label="label.hsn_code"
                  [placeholder]="'placeholder.enter_hsn'" labelPlacement="floating" fill="outline"></app-input>
              </div>

              <div class="ion-display-flex ion-margin-bottom">
                <app-select class="ion-flex-1" [meta]="chargeTaxTypeMeta" />
                <app-input class="ion-flex-1 ion-margin-start" [form]="chargeForm" name="gstRate" label="label.gst_rate"
                  [placeholder]="'placeholder.enter_value'" labelPlacement="floating" type="number"
                  [errorText]="'error.required'" fill="outline"></app-input>
              </div>

              <div class="ion-margin-bottom">
                <app-input [form]="chargeForm" name="cessRate" label="label.cess_rate"
                  [placeholder]="'placeholder.enter_value'" labelPlacement="floating" type="number"
                  fill="outline"></app-input>
              </div>

              <div class="ion-margin-bottom">
                <app-input [form]="chargeForm" name="totalAmount" label="label.total_amount"
                  [placeholder]="'placeholder.calculated'" labelPlacement="floating" type="number"
                  fill="outline"></app-input>
              </div>

              @if (additionalChargeForms().length > 1) {
              <div class="ion-margin-bottom">
                <ion-button expand="block" color="danger" (click)="removeAdditionalCharge($index)">
                  <ion-icon name="trash" slot="start"></ion-icon>
                  {{ 'common.remove_charge' | translate }}
                </ion-button>
              </div>
              }
            </form>
          </div>
          }
        </div>
        }

         <button type="submit" style="display: none;" [disabled]="formMeta.submitProcessing"></button>

      </form>
    </div>
    } @else {
    <div class="ion-padding ion-text-center">
      <ion-spinner></ion-spinner>
    </div>
    }
  </div>
</ion-content>

<!-- <ion-footer>
  <ion-toolbar>
    <ion-button expand="block" type="submit" form="saleForm" [disabled]="isSubmitting()">
      @if (isSubmitting()) {
      <ion-spinner name="crescent"></ion-spinner>
      } @else {
      <ion-icon name="save-outline" slot="start"></ion-icon>
      {{ (isEdit() ? 'common.update_sale' : 'common.create_sale') | translate }}
      }
    </ion-button>
  </ion-toolbar>
</ion-footer> -->

<ion-footer class="bottom-footer">
  <ion-toolbar>
    <div class="action-buttons">
      <ion-button fill="outline" class="preview-btn">
        Preview
      </ion-button>

      <ion-button fill="outline" class="save-btn" (click)="onSubmit()"> 
        Save
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>

<!-- <ion-footer class="ion-no-border" [translucent]="true" mode="ios">
  @if(!isCustomerSave()){
  <ion-tab-bar>
    @if(!openedAsModal){
    <ion-tab-button (click)="onSubmit(true)" [disabled]="formMeta.submitProcessing">
      <ion-icon name="add-circle-outline"></ion-icon>
      <ion-label>{{ 'button.add_more' | translate }}</ion-label>
    </ion-tab-button>
    }
    <ion-tab-button (click)="onSubmit(false)" [disabled]="formMeta.submitProcessing">
      <ion-icon name="save-outline"></ion-icon>
      <ion-label>{{ 'button.save' | translate }}</ion-label>
    </ion-tab-button>
  </ion-tab-bar>
  } @else {
  <ion-tab-bar>
    <ion-tab-button [disabled]="formMeta.submitProcessing">
      <ion-spinner name="crescent"></ion-spinner>
      <ion-label>{{ 'common.saving' | translate }}</ion-label>
    </ion-tab-button>
  </ion-tab-bar>
  }
</ion-footer> -->